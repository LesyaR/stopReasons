
## Predictions results

Overall statistics and findings on the Clinical Trial stop reasons

```{r, predictions_dataConfig}
precitions_path <- "gs://ot-team/dochoa/predictions_stop.tsv"
gs_path <- "gs://open-targets-data-releases/"
data_release <- "21.06"
all_evidence_path <- paste(
    gs_path, data_release,
    "/output/etl/parquet/evidence/",
    sep = ""
)
# disease_path <- paste(
#     gs_path, data_release,
#     "/output/etl/parquet/diseases/",
#     sep = ""
# )
```

```{r, dataStopReasons}
## Olesya's predictions for stop reason class
precitions_path <- "gs://ot-team/dochoa/predictions_stop.tsv"
stop_predictions <- spark_read_csv(
    sc,
    path = precitions_path,
    delimiter = "\t",
    header = TRUE,
    memory = FALSE
    ) %>%
    filter(is.na(prediction) != TRUE) %>%
        select("nctid" = "nct_id", prediction) %>%
        sdf_distinct()
```

**Platform clinical data**. All information from ChEMBL: Clinical trial information + DailyMed + FDA. Includes a few other relevant fields: study start dates, clinical phase, stop reason.

```{r, dataClinical}
clinical <- spark_read_parquet(sc, all_evidence_path, memory = FALSE) %>%
    filter(sourceId == "chembl") %>%
    select(targetId, diseaseId, clinicalStatus,
        clinicalPhase, studyStopReason, urls,
        studyStartDate) %>%
    sdf_unnest(urls) %>%
    mutate(nctid = regexp_extract(url, "(.+)(id=%22)(.+)(%22)", 3)) %>%
    left_join(stop_predictions, by = "nctid") %>%
    mutate(nctid = ifelse(nctid == "", NA, nctid)) %>%
    select(-url)
```

Clinical trial stop reason by year

```{r, plotPredictionsByTime}

stopped_trials <- clinical %>%
    filter(!is.na(prediction)) %>%
    select(
        nctid, studyStartDate, prediction,
        clinicalStatus, clinicalPhase
    ) %>%
    sdf_distinct() %>%
    collect()


stop_to_plot <- stopped_trials %>%
    filter(as.Date(studyStartDate) <= today()) %>%
    mutate(year = year(as.Date(studyStartDate))) %>%
    group_by(year, prediction) %>%
    summarise(count = n(), .groups = "drop") %>%
    complete(year, prediction) %>%
    mutate(
        interval = cut(
            count,
            breaks = c(1, 5, 10, 25, 100, 150, Inf),
            include.lowest = TRUE,
            right = FALSE
        )
    ) %>%
    mutate(interval = fct_recode(interval,
        "1-4" = "[1,5)",
        "5-9" = "[5,10)",
        "10-24" = "[10,25)",
        "25-99" = "[25,100)",
        "100-149" = "[100,150)",
        "150+" = "[150,Inf]"
    ))

stop_to_plot %>%
    ggplot(aes(
        x = year,
        y = fct_reorder(prediction, count, sum, na.rm = TRUE)
    )) +
    geom_tile(aes(fill = interval), color = "white", size = .5) +
    scale_x_continuous(expand = c(0, 0)) +
    scale_fill_manual(
        name = "Stopped trials",
        na.value = "lightgrey",
        values = viridisLite::viridis(length(levels(stop_to_plot$interval))),
        breaks = levels(stop_to_plot$interval)
    ) +
    # scale_fill_viridis_b(na.value = "grey90") +
    coord_fixed() +
    theme_light() +
    theme(
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        panel.border = element_blank(),
        axis.title = element_blank()
    )
```

Selected prediction classes as they progress in clinical trials.

```{r, predictionByPhase}

stopped_trials %>%
    group_by(clinicalPhase, prediction) %>%
    summarise(count = n(), .groups = "drop") %>%
    inner_join(
        stopped_trials %>%
            group_by(clinicalPhase) %>%
            summarise(stoppedByPhase = n()),
        by = "clinicalPhase"
    ) %>%
    mutate(stopRatio = (count / stoppedByPhase)) %>%
    filter(prediction %in% c("Safety_Sideeffects",
    "Negative", "Study_Staff_Moved")) %>%
    ggplot(aes(x = clinicalPhase, y = stopRatio, fill = fct_rev(prediction))) +
        geom_area(alpha = 0.7, size = .25, color = "black") +
        scale_y_continuous(
            name = "Stopped studies (%)",
            labels = scales::percent,
            expand = c(0, 0)
        ) +
        scale_x_continuous(
            name = "Clinical Phase",
            expand = c(0, 0)
        ) +
        scale_fill_viridis_d(name = "Stop reason") +
    theme_bw() +
    theme(
        legend.position = c(1, 1),
        legend.justification = c(1, 1),
        legend.background = element_blank(),
        legend.margin = margin(r = 10, t = 10, unit = "pt")
    )
```
